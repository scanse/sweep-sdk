language: generic
sudo: required
dist: trusty


matrix:
  fast_finish: true

  include:
    - os: linux
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test']
          packages: ['g++-6', 'cmake', 'python3', 'python3-pip', 'nodejs', 'npm', 'libsfml-dev', 'libprotobuf-dev', 'protobuf-compiler', 'libzmq-dev']
      env: CCOMPILER='gcc-6' CXXCOMPILER='g++-6'

    - os: linux
      addons:
        apt:
          sources: ['ubuntu-toolchain-r-test']
          packages: ['g++-5', 'cmake', 'python3', 'python3-pip', 'nodejs', 'npm', 'libsfml-dev', 'libprotobuf-dev', 'protobuf-compiler', 'libzmq-dev']
      env: CCOMPILER='gcc-5' CXXCOMPILER='g++-5'

    - os: linux
      addons:
        apt:
          sources: ['llvm-toolchain-precise-3.8']
          packages: ['clang-3.8', 'cmake', 'python3', 'python3-pip', 'nodejs', 'npm', 'libsfml-dev', 'libprotobuf-dev', 'protobuf-compiler', 'libzmq-dev']
      env: CCOMPILER='clang-3.8' CXXCOMPILER='clang++-3.8'


before_install:
  - export CC=${CCOMPILER} CXX=${CXXCOMPILER}
  - sudo update-alternatives --install /usr/bin/node node /usr/bin/nodejs 10

install:
  # Make sure building and installing libsweep works
  - pushd libsweep
  - make
  - sudo make install
  - make clean
  # Then build and install dummy library to test bindings against without device attached
  - make dummy
  - sudo make install
  - popd
  # Install Python bindings
  - pushd sweeppy
  - pip3 install setuptools # apparently this version of 3 doesn't have setuptools
  - sudo python2 setup.py install
  - sudo python3 setup.py install
  - popd

script:
  # Test libsweep examples against the dummy library
  - pushd libsweep/examples
  - mkdir build
  - cd build
  - cmake ..
  - cmake --build .
  - ./example-c
  - ./example-c++
  - popd
  # Test SweepPy bindings against the dummy library
  - pushd sweeppy
  - python2 tests/test.py
  - python3 tests/test.py
  - popd
  # Test SweepJs bindings against the dummy library
  - pushd sweepjs
  - npm install
  - popd
